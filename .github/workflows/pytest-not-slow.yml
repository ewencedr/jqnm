name: Run pytest for not-slow tests

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # This allows us to manually trigger

jobs:
  define-matrix:
    runs-on: ubuntu-latest

    outputs:
      configurations: ${{ steps.matrix.outputs.configurations }}

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Define matrix
        id: matrix
        run: |
          # "$GITHUB_OUTPUT" will be a json file containing all the configurations
          python .github/workflows/build_matrix.py "$GITHUB_OUTPUT"

          # we need to prepend with the output name
          echo "configurations="`cat "$GITHUB_OUTPUT"` > "$GITHUB_OUTPUT"

  build:
    if: "!contains(github.event.head_commit.message, 'ci skip')"

    continue-on-error: true
    needs: define-matrix
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        configuration: ${{ fromJSON(needs.define-matrix.outputs.configurations) }}

    runs-on: ${{ matrix.configuration.os }}

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.configuration.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.configuration.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt ${{ matrix.configuration.packages }}
          pip list

      - name: Install package
        run: |
          pip install .

      - name: Install test dependencies
        run: |
          pip install pytest
          # Install original qnm for comparison tests
          pip install qnm

      - name: Download QNM data
        run: |
          python -c "import jqnm; jqnm.download_data()"

      - name: Lint with flake8
        run: |
          pip install flake8

          # stop the build if there are Python syntax errors or undefined names
          flake8 --count --exclude .git,build,__pycache__ --select=E9,F63,F7,F82 --show-source --statistics .

          # exit-zero treats all errors as warnings
          flake8 --count --exclude .git,build,__pycache__ --exit-zero --max-complexity=10 --max-line-length=127 --statistics .

      - name: Test with pytest (excluding comparison tests)
        run: |
          # Run tests excluding comparison tests (which require special import handling)
          pytest -vv -m "not slow" --ignore=test/test_comparison_qnm.py
